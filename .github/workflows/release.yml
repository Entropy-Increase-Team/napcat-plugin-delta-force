name: Build and Release

on:
  push:
    branches: [main, master]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - run: pnpm install --no-frozen-lockfile

      - name: Get version
        id: ver
        run: echo "version=v$(node -e "console.log(require('./package.json').version)")" >> $GITHUB_OUTPUT

      - run: pnpm build

      - name: Package
        run: |
          mkdir -p release
          cp dist/index.mjs release/
          cp dist/package.json release/
          cp -r dist/webui release/
          cp -r dist/resources release/
          cd release && zip -r ../napcat-plugin-delta-force.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: napcat-plugin-delta-force
          path: napcat-plugin-delta-force.zip

      - name: Delete old latest release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: gh release delete latest --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old latest tag
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git tag -d latest || true
          git push origin :refs/tags/latest || true

      - name: Create Release (push to main)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          gh release create latest napcat-plugin-delta-force.zip \
            --title "${{ steps.ver.outputs.version }}" \
            --notes "自动构建 ${{ steps.ver.outputs.version }}" \
            --latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto tag version
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        id: autotag
        run: |
          TAG="${{ steps.ver.outputs.version }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag "$TAG"
            git push origin "$TAG"
            echo "created=true" >> $GITHUB_OUTPUT
            echo "Created tag $TAG"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists, skipping"
          fi

      - name: Create Version Release (auto tag)
        if: steps.autotag.outputs.created == 'true'
        run: |
          gh release create "${{ steps.ver.outputs.version }}" napcat-plugin-delta-force.zip \
            --title "${{ steps.ver.outputs.version }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Version Release (manual tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: napcat-plugin-delta-force.zip
          generate_release_notes: true

      - name: Trigger index update
        if: steps.autotag.outputs.created == 'true' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.ver.outputs.version }}' || '${{ github.ref_name }}';
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-index.yml',
              ref: 'main',
              inputs: { version }
            })
            console.log('Triggered index update for ' + version)
